{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedFile - Categories Management</title>
    <link rel="stylesheet" href="{% static 'css/category.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile_dialog.css' %}">
    <script src="{% static 'js/profile_dialog.js' %}"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div>
            <div class="navbar-brand">
                <div class="icon">üìÅ</div>
                MedFile
            </div>
            <div class="navbar-subtitle">File Management System</div>
        </div>
        <div class="navbar-right">
            <div class="user-badge">{{ request.user.department }}</div>
            <div class="user-avatar" onclick="toggleProfileDialog()">{{ request.user.first_name|first|default:request.user.username|first }}</div>
            
            <!-- Mini Profile Dialog -->
            <div id="profileDialog" class="profile-dialog">
                <div class="profile-content">
                    <div class="profile-header">
                        <div class="large-avatar">{{ request.user.first_name|first|default:request.user.username|first }}</div>
                        <div class="user-info">
                            <div class="full-name">{{ request.user.get_full_name|default:request.user.username }}</div>
                            <div class="username">@{{ request.user.username }}</div>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <span class="label">Department:</span>
                            <span class="value">{{ request.user.department }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Login Status:</span>
                            <span class="value status-active">Active</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Last Login:</span>
                            <span class="value">{{ request.user.last_login|date:"M d, Y H:i" }}</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <a href="{% url 'login' %}" class="logout-btn" onclick="handleLogout(event)">
                            <span class="icon">üö™</span> Log Out
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Categories Management</h1>
            <p>Create and manage file categories for better organization</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="tab-nav">
            <a href="{% url 'dashboard' %}" class="tab-btn {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" data-tab="dashboard">Dashboard</a>
            <a href="{% url 'upload' %}" class="tab-btn {% if request.resolver_match.url_name == 'upload' %}active{% endif %}" data-tab="upload">Upload Files</a>
            <a href="{% url 'file_browser' %}" class="tab-btn {% if request.resolver_match.url_name == 'file_browser' %}active{% endif %}" data-tab="browse">Browse Files</a>
            <a href="{% url 'usermanagement' %}" class="tab-btn {% if request.resolver_match.url_name == 'usermanagement' %}active{% endif %}" data-tab="users">User Management</a>
            <a href="{% url 'categories' %}" class="tab-btn {% if request.resolver_match.url_name == 'categories' %}active{% endif %}" data-tab="categories">Categories</a>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}error{% else %}success{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Categories Management Section -->
        <div class="categories-management">
            <div class="section-header">
                <div>
                    <div class="section-title">
                        <span>üè∑Ô∏è</span>
                        <h2>File Categories</h2>
                    </div>
                    <div class="section-subtitle">Organize files with categories and subcategories</div>
                </div>
                <button class="add-category-btn" onclick="openAddCategoryModal()">
                    <span>+</span>
                    Add Category
                </button>
            </div>

            <!-- Categories Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Department</th>
                            <th>Files</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                        {% for category in categories %}
                        <tr>
                            <td>
                                <span class="category-name">{{ category.name }}</span>
                                <div class="category-description">{{ category.description }}</div>
                            </td>
                            <td>{{ category.get_department_display }}</td>
                            <td>{{ category.year_folders.count }}</td>
                            <td>
                                <span class="category-status {% if category.is_active %}status-active{% else %}status-inactive{% endif %}">
                                    {% if category.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="action-btn edit-btn" onclick="editCategory('{{ category.id }}')">‚úèÔ∏è</button>
                                    <button class="action-btn delete-btn" onclick="confirmDeleteCategory('{{ category.id }}', '{{ category.name }}')">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" style="text-align: center;">No categories found. Add your first category!</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Category</h3>
                <button class="close-btn" onclick="closeAddCategoryModal()">&times;</button>
            </div>
            <form id="addCategoryForm" method="POST" action="{% url 'categories' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="categoryName">Category Name *</label>
                    <input type="text" id="categoryName" name="name" required placeholder="e.g., Neurology">
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Description</label>
                    <textarea id="categoryDescription" name="description" placeholder="Brief description of this category"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryDepartment">Department *</label>
                    <select id="categoryDepartment" name="department" required>
                        <option value="">Select Department</option>
                        {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="categoryIsActive">Status</label>
                    <select id="categoryIsActive" name="is_active">
                        <option value="true" selected>Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddCategoryModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Category</h3>
                <button class="close-btn" onclick="closeEditCategoryModal()">&times;</button>
            </div>
            <form id="editCategoryForm" method="POST" action="">
                {% csrf_token %}
                <input type="hidden" name="_method" value="PUT">
                <input type="hidden" id="editCategoryId" name="category_id">
                <div class="form-group">
                    <label for="editCategoryName">Category Name *</label>
                    <input type="text" id="editCategoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editCategoryDescription">Description</label>
                    <textarea id="editCategoryDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="editCategoryDepartment">Department *</label>
                    <select id="editCategoryDepartment" name="department" required>
                        <option value="NEONATAL">Neonatal Care</option>
                        <option value="PEDIATRIC">Pediatrics</option>
                        <option value="EMERGENCY">Emergency</option>
                        <option value="SURGERY">Surgery</option>
                        <option value="LAB">Laboratory</option>
                        <option value="RADIOLOGY">Radiology</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editCategoryIsActive">Status</label>
                    <select id="editCategoryIsActive" name="is_active">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditCategoryModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteCategoryModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Confirm Deletion</h3>
                <button class="close-btn" onclick="closeDeleteCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the category "<span id="categoryToDeleteName"></span>"?</p>
                <p class="category-description">This action cannot be undone.</p>
            </div>
            <div class="modal-actions">
                <form id="deleteCategoryForm" method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="hidden" id="deleteCategoryId" name="category_id">
                    <button type="button" class="btn-secondary" onclick="closeDeleteCategoryModal()">Cancel</button>
                    <button type="submit" class="btn-primary" style="background-color: #dc2626;">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'js/category.js' %}"></script>
</body>
</html>